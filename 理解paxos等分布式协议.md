## Lease 机制 

Lease 机制牺牲了部分异常情况下的 A，从而获得了完全的 C 与很好的 P。

首先，Lease 机制不是在任何情况下都具有可用性的，使用 Lease 机制的协议，在发生异常时，需要等待 Lease 超时才能收回 Lease 权限。然而，Lease 的持有者可能在 Lease 超时前就已经出现异常而不能提供服务了，直到 Lease 超时这段时间内，系统服务的可用性都有问题。例如，如果用 lease 决定 Primary 副本的，Primary 副本节点宕机后，只有待 Lease 超时才能选出新的 primary副本，这段时间由于缺乏 primary副本是没有更新服务的。再者，Lease协议本身保证了对于Lease约定的承诺在Lease颁发者和持有者之间是始终一致的。即使Lease持有者由于网络分化没有真正收到 Lease，Lease 颁发者也会在 Lease 时间内执行自己的承诺；而一旦 Lease 持有者收到 Lease，则即使再出现网络分化，也无法影响双方对 Lease 承诺理解的一致性。
最后，Lease 协议引入了“时间”这一概念，使得在对抗网络分化上有其特别的优势，另外，Lease只需由颁发者向持有者通信，即使网络是单向的也不影响 Lease 协议的正常工作

## Quorum 机制 

这里仅讨论一般的 Quorum 机制，即总共有 N 个副本，成功更新 W 个副本则算成功提交，读取时读 R 个副本。这种一般的 Quorum 机制，在 CAP 三大因素中都各做了折中，有一定的 C，有较好的 A，也有较好的 P，是一种较为平衡的分布式协议。 

首先，读取 R 个副本时，可以保证读取到成功提交的版本，但无法保证读取到最新的成功提交的版本（2.4.4 ） 。也就是说，系统具有一定的一致性，却无法真正做到强一致性。再者，无论是更新 W 个副本，还是读取 R 个副本，协议可以允许部分副本异常而不影响更新或者读取服务。最后，只要能与 W 个副本通信就可以提供更新服务，能与 R 个副本通信就可以提供读服务，协议具有一定的容忍网络分化的能力。工程中，当使用 3 个副本时，可以讲三个副本部署在三个不同的机房，只有同时出现两个机房的网络都异常时才会影响服务，这种情况的概率本身已经非常低了

## 两阶段提交协议 

两阶段提交系统具有完全的 C，很糟糕的 A，很糟糕的 P。 

首先，两阶段提交协议保证了副本间是完全一致的，这也是协议的设计目的。再者，协议在一个节点出现异常时，就无法更新数据，其服务可用性较低。最后，一旦协调者与参与者之间网络分化，无法提供服务。 

## Paxos 协议 

同样是强一致性协议，Paxos 在 CAP 三方面较之两阶段提交协议要优秀得多。Paxos 协议具有完全的 C，较好的 A，较好的 P。Paxos 的 A 与 P 的属性与 Quorum 机制类似，因为 Paxos 的协议本身就具有 Quorum 机制的因素。 

首先，无需赘述，Paxos 协议是一种强一致性协议。再者，Paxos 协议只有两种情况下服务不可用：一是超过半数的 Proposer 异常，二是出现活锁。前者可以通过增加 Proposer 的个数来降低由于 Proposer 异常影响服务的概率，后者本身发生的概率就极低。最后，只要能与超过半数的Proposer 通信就可以完成协议流程，协议本身具有较好的容忍网络分区的能力。 

## paxos活锁

互相不服，不断对提议轮次+1，始终无法成功

1. Proposer 1 以 b=1 提起议案，发送 prepare(1)消息，各 Acceptor 都正确处理,回应 promise(1, NULL) 
2. Proposer 2 以 b=2 提起议案，发送 prepare(2)消息，各 Acceptor 都正确处理,回应 promise(2, NULL) 
3. Proposer 1 收到 5 个 promise(1, NULL)消息，选择 value 为 v1发送 accept(1, v1)消息，然而这 个消息被所有的 Acceptor 拒绝，收到 5 个 Nack(2)消息。 
4. Proposer 1 以 b=3 提起议案，发送 prepare(3)消息，各 Acceptor 都正确处理,回应 promise(3, NULL) 
5. Proposer 2 收到 5 个 promise(2, NULL)消息，选择 value 为 v2发送 accept(2, v2)消息，然而这 个消息被所有的 Acceptor 拒绝，收到 5 个 Nack(3)消息。

上述过程交替进行，则永远无法批准一个 value，从而形成 Paxos 协议活锁。Paxos 协议活锁问题也是这个协议的主要问题。 

## paxos描述和用途

理解paxos用的位置，paxos经常在不同系统里和其他协议并存，比如lease、raft，用来解决不同问题。
Proposer 提出议案（value）。所谓 value，在工程中可以是“任何操作”，例如“修改某个变量的值为某个值”、“设置当前 primary 为某个节点”等等。

```
二阶段 -> raft ->paxos
少数服从多数原则、按序号大的提议来、只能通过发起新一轮提议修改以前的结论
````